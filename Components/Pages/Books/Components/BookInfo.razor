@using BookHeaven.Domain.Enums
@if (Book == null)
{
	return;
}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
	<div class="border-2 h-[95%] w-[90%] overflow-hidden border-gray-700 bg-white p-5">
		<div class="mb-2 flex items-center gap-2">
			<Button Kind="Button.ButtonType.Secondary" Class="text-xs" OnClick="@(() => DeleteBook())">
				<svg  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1"  stroke-linecap="round"  stroke-linejoin="round"  class="size-4 icon icon-tabler icons-tabler-outline icon-tabler-trash"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
				Delete
			</Button>
			<Button Kind="Button.ButtonType.Secondary" Class="text-xs" OnClick="@(() => BookManager.ClearCache(Book))">
				<svg  xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1"  stroke-linecap="round"  stroke-linejoin="round"  class="size-4 icon icon-tabler icons-tabler-outline icon-tabler-recycle"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 17l-2 2l2 2" /><path d="M10 19h9a2 2 0 0 0 1.75 -2.75l-.55 -1" /><path d="M8.536 11l-.732 -2.732l-2.732 .732" /><path d="M7.804 8.268l-4.5 7.794a2 2 0 0 0 1.506 2.89l1.141 .024" /><path d="M15.464 11l2.732 .732l.732 -2.732" /><path d="M18.196 11.732l-4.5 -7.794a2 2 0 0 0 -3.256 -.14l-.591 .976" /></svg>
				Clear cache
			</Button>
			@if (Book.ReadingStatus() != BookStatus.New)
			{
				<Button Kind="Button.ButtonType.Secondary" Class="text-xs" OnClick="@ResetProgress">
					<svg  xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1"  stroke-linecap="round"  stroke-linejoin="round"  class="size-4 icon icon-tabler icons-tabler-outline icon-tabler-restore"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3.06 13a9 9 0 1 0 .49 -4.087" /><path d="M3 4.001v5h5" /><path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" /></svg>
					Reset progress
				</Button>
			}

			<button class="ms-auto" @onclick="async () => await BookChanged.InvokeAsync(null)">
				<svg  xmlns="http://www.w3.org/2000/svg"   viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1"  stroke-linecap="round"  stroke-linejoin="round"  class="size-8 icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>
			</button>
		</div>
		<div class="grid-cols-[150px_1fr] grid items-start gap-5">
			<div class="grid gap-2">
				<img src="@Book.GetCoverAsBase64(MauiProgram.CoversPath)" class="block w-full" alt=""/>
				<span class="bg-neutral-600 px-2 py-1 text-center text-xs text-white">
					@switch (Book.ReadingStatus())
					{
						case BookStatus.New:
							<span>@Translations.NEW</span>
							break;
						case BookStatus.Reading:
							<span>@Translations.IN_PROGRESS</span>
							break;
						case BookStatus.Finished:
							<span>@Translations.FINISHED</span>
							break;
					}
				</span>
			</div>
			<div>
				<hr />
				<p class="my-1 font-bold">@Translations.DETAILS</p>
				<hr class="mb-2"/>
				<p class="text-xl">@Book.Title</p>
				@if (Book.Series != null)
				{
					<p>@Book.Series.Name</p>
				}
				<p>@Book.Author?.Name</p>
				@if (Book.ReadingStatus() != BookStatus.New)
				{
					<hr class="mt-4"/>
					<p class="my-1 font-bold">@Translations.STATS</p>
					<hr class="mb-2"/>
					<div class="grid-cols-2 grid gap-1">
						<span>@Translations.START_DATE</span>
						<span>@Book.Progress().StartDate?.ToString("d")</span>
						<span>@Translations.END_DATE</span>
						<span>@Book.Progress().EndDate?.ToString("d")</span>
						<span>@Translations.PROGRESS</span>
						<span>@Book.Progress().Progress.ToString("0.#")%</span>
						<span>@Translations.READ_TIME</span>
						<span>@Book.Progress().ElapsedTimeFormatted()</span>
					</div>
				}
			</div>
			@if (!string.IsNullOrEmpty(Book.Description))
			{

				<div class="col-span-2">
					<hr/>
					<p class="mt-2 text-xs">@((MarkupString)Book.Description)</p>
				</div>
			}

		</div>
	</div>
</div>

@code {
	[Inject] private BookManager BookManager { get; set; } = null!;
	[Inject] private AlertService Alert { get; set; } = null!;

	[Parameter] public Book? Book { get; set; }
	[Parameter] public EventCallback<Book?> BookChanged { get; set; }

	private async Task DeleteBook()
	{
		var result = await Alert.ShowConfirmationAsync("Delete book", $"Are you sure you want to delete this book?{Environment.NewLine}{Environment.NewLine}This will remove the book from your device along with any progress you have.{Environment.NewLine}Whatever you have on your server will remain intact.");
		if (result)
		{
			await BookManager.DeleteBook(Book!);
			Book = null;
			await BookChanged.InvokeAsync(Book);
		}
	}

	private async Task ResetProgress()
	{
		var result = await Alert.ShowConfirmationAsync("Reset Progress", $"Are you sure you want to clear the progress?{Environment.NewLine}{Environment.NewLine}This action cannot be undone, but it can be recovered from the server (as long as you have synced it already) if you just delete the book and download it again.");
		if (result)
		{
			await BookManager.ResetProgress(Book!);
			await BookChanged.InvokeAsync(Book);
		}
		
	}
}