@using System.ComponentModel
@using BookHeaven.Domain.Features.Fonts
@implements IDisposable
<style>
	@foreach (var font in _fonts)
	{
		@font.GetFontFace()
	}
	@@scope (#viewer) {
		:scope {
			font-family: '@ReaderService.ProfileSettings.SelectedFont', serif;
		}
	}
</style>
@code {
	[Inject] ReaderService ReaderService { get; set; } = null!;
	[Inject] ISender Sender { get; set; } = null!;
	[Inject] AppStateService AppStateService { get; set; } = null!;
	
	List<Font> _fonts = [];
	string? _fontFamily = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		ReaderService.ProfileSettings.PropertyChanged += OnSelectedFontChanged;
		await GetFonts();
	}
	
	private async Task GetFonts()
	{
		_fontFamily = ReaderService.ProfileSettings.SelectedFont;
		var getFonts = await Sender.Send(new GetAllFonts.Query(_fontFamily));
		if (getFonts.IsFailure)
		{
			return;
		}

		_fonts = getFonts.Value;
	}
	
	private async void OnSelectedFontChanged(object? sender, PropertyChangedEventArgs args)
	{
		if (args.PropertyName != nameof(ProfileSettings.SelectedFont)) return;

		await GetFonts();
		await InvokeAsync(StateHasChanged);
	}

	public void Dispose()
	{
		ReaderService.ProfileSettings.PropertyChanged -= OnSelectedFontChanged;
	}

}