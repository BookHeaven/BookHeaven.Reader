@using BookHeaven.Domain.Features.Fonts
@implements IDisposable
@if(_fonts.Count == 0) return;
<style>
	@foreach (var font in _fonts)
	{
		@font.GetFontFace()
	}
	@@scope (#viewer) {
		:scope {
			font-family: '@ProfileSettingsService.ProfileSettings.SelectedFont', serif;
		}
	}
</style>
@code {
	[Inject] ProfileSettingsService ProfileSettingsService { get; set; } = null!;
	[Inject] ISender Sender { get; set; } = null!;
	[Inject] AppStateService AppStateService { get; set; } = null!;
	
	List<Font> _fonts = [];
	string? _fontFamily = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		ProfileSettingsService.OnProfileSettingsChanged += OnSelectedFontChanged;
		await GetFonts();
	}
	
	private async Task GetFonts()
	{
		_fontFamily = ProfileSettingsService.ProfileSettings.SelectedFont;
		var getFonts = await Sender.Send(new GetAllFonts.Query(_fontFamily));
		if (getFonts.IsFailure)
		{
			return;
		}

		_fonts = getFonts.Value;
	}
	
	private async void OnSelectedFontChanged(string? propertyName)
	{
		if (propertyName != nameof(ProfileSettings.SelectedFont)) return;

		await GetFonts();
		await InvokeAsync(StateHasChanged);
	}

	public void Dispose()
	{
		ProfileSettingsService.OnProfileSettingsChanged-= OnSelectedFontChanged;
	}

}